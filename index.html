<!doctype html>
<meta charset=utf8>
<h3>Browser Occam</h3>
<!--<script src="editor.bundle.js"></script>-->
<script src="jison/occam.js"></script>
<script>
    function parse () {
        var input = document.getElementById("editor").value.concat(" ")
        
        try {
            var result = occam.parse(input);
            var tree = (organise(result));
            document.getElementById("jsonTree").innerHTML = "Syntax tree as JSON: " + JSON.stringify(tree, null, 2);
            return tree

        } catch (e) {
            document.getElementById("jsonTree").innerHTML = "Parsing Error: " + e.toString();
            return false
        }

        function organise (input) {
            if(typeof input == "string"){
                return {idleaf: input}
            }else if (typeof input == "number"){
                return {numleaf: input}
            } else {
                var cs = []
                for (let i = 1; i < input.length; i++){
                    cs.push(organise(input[i]))
                }

                return { rule: input[0],
                         children: cs }
            }
        }
    }

    function sendElm () {

        var elm = document.getElementById("elm-app-div");
        var json = parse()

        if (json){
            app.ports.messageReceiver.send(json);
            elm.style.display = "block";
        } else {
            elm.style.display = "none";
        }
    }
</script>

<div style="display: flex; flex-direction: row; column-gap: 10px;">

    <div style="width: 50vw; display:flex; flex-direction: column;">
        <textarea id="editor" style="min-height: 50vh;">
SEQ 
    CHAN OF INT chan:
    INT x:
    PAR
        WHILE TRUE
            SEQ
                chan ! 0
                chan ! 11
        WHILE TRUE
            chan ? x
        </textarea>
        <button onclick="sendElm()">begin interpreting</button>

        <pre id="jsonTree"></pre>
    </div>

    <div id="elm-app-div" style="display: none;">
        <div id="elm-app"></div>
    </div>
    <script src="elm/elm.js"></script>
    <script>
    var app = Elm.Main.init({
        node: document.getElementById("elm-app")
    });      
    </script>

</div>