<!doctype html>
<meta charset=utf8>
<head>
<script src="editor.bundle.js"></script>
<script src="jison/occam.js"></script>
<link rel="stylesheet" type="text/css" href="index.css">
</head>
<h3 style="padding: 15px; margin-bottom: 4px; margin-top: 0px; border-radius: 4px;"><a href="index.html">Browser Occam</a></h3>
<div class="navbar"><a href="index.html"><div>Home</div></a><a href="instructions.html"><div>Tutorial</div></a><a href="examples.html"><div>Examples</div></a><a href="https://github.com/autay27/boccam/"><div>GitHub</div></a></div>
<script>

    var time = 0
    function parse (input) {

        //var input = codemirror.getCode().trim().concat(" ")
        //try {occam.parse("abba daba doo")} catch (e){console.log("parser doesn't REMEMBER")}

        try {

            var error =
            `SEQ k
                x := 1`

            var ok =
            `SEQ
                x := 1`

            //var thisTime = (time == 0) ? error : ok
            //var result = occam.parse(thisTime.trim().concat(" "));
            var result = occam.parse(input.trim().concat(" "));
            var tree = (organise(result));
            //document.getElementById("jsonTree").innerHTML = "Syntax tree as JSON: " + JSON.stringify(tree, null, 2);
            document.getElementById("jsonTree").innerHTML = "";
            return tree

        } catch (e) {
            document.getElementById("jsonTree").innerHTML = "I couldn't read your code, maybe you have a typo or a missing SEQ? Here is the error:<hr>" + e.message;
            time = time + 1
            try { occam.parse("INT x:".trim().concat(" ")) } catch(e){}
            return false
        }

        function organise (input) {
            if(typeof input == "string"){
                return {idleaf: input}
            }else if (typeof input == "number"){
                return {numleaf: input}
            } else {
                var cs = []
                for (let i = 1; i < input.length; i++){
                    cs.push(organise(input[i]))
                }

                return { rule: input[0],
                         children: cs }
            }
        }
    }

    function sendElm () {

        var elm = document.getElementById("elm-app-div");
        var json = parse(codemirror.getCode())

        if (json){
            app.ports.messageReceiver.send(json);
            elm.style.display = "block";
        } else {
            elm.style.display = "none";
        }
    }
</script>


<body>
<div style="display: flex; flex-direction: row; column-gap: 10px;">

    <div style="width: 40vw; display:flex; flex-direction: column;">
    <button onclick="sendElm()">Submit code</button>
    <div id="editor"></div>
        <pre style="width: 40vw;" id="jsonTree"></pre>
    </div>

    <div id="elm-app-div" style="display: none;">
        <div id="elm-app"></div>
    </div>
    <script src="elm/elm.js"></script>
    <script>
    var app = Elm.Main.init({
        node: document.getElementById("elm-app")
    });
    </script>

</div>

</body>
