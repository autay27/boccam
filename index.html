<!doctype html>
<meta charset=utf8>

<head>
<script src="jison/occam.js"></script>
<link rel="stylesheet" type="text/css" href="index.css">
<script type="text/javascript" src="editor.bundle.js"></script>

</head>

<h3>Browser Occam</h3>

<script>
    function parse () {

        var input = codemirror.getCode().concat(" ")
        
        try {
            var result = occam.parse(input);
            var tree = (organise(result));
            document.getElementById("jsonTree").innerHTML = "Syntax tree as JSON: " + JSON.stringify(tree, null, 2);
            return tree

        } catch (e) {
            document.getElementById("jsonTree").innerHTML = "I couldn't read your code, maybe you have a typo or a missing SEQ? Here is the error:<hr>" + e.message;
            throw e
            return false
        }

        function organise (input) {
            if(typeof input == "string"){
                return {idleaf: input}
            }else if (typeof input == "number"){
                return {numleaf: input}
            } else {
                console.log(input)
                var cs = []
                for (let i = 1; i < input.length; i++){
                    cs.push(organise(input[i]))
                }

                return { rule: input[0],
                         children: cs }
            }
        }
    }

    function sendElm () {

        var elm = document.getElementById("elm-app-div");
        var json = parse()

        if (json){
            app.ports.messageReceiver.send(json);
            elm.style.display = "block";
        } else {
            elm.style.display = "none";
        }
    }
</script>

<div style="display: flex; flex-direction: row; column-gap: 10px;">

    <div id="editarea" style="width: 50vw; display:flex; flex-direction: column;">
    <div id="editor"></div>
        <button onclick="sendElm()">begin interpreting</button>

        <pre id="jsonTree"></pre>
    </div>

    <div id="elm-app-div" style="display: none;">
        <div id="elm-app"></div>
    </div>
    <script src="elm/elm.js"></script>
    <script>
    var app = Elm.Main.init({
        node: document.getElementById("elm-app")
    });      
    </script>

</div>
